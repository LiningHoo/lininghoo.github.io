<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="hlnBlog">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="hlnBlog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Lining Hoo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>hlnBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">hlnBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/23/%E4%BD%BF%E7%94%A8-Sarama-%E5%BE%80-Kafka-%E5%8F%91%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lining Hoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hlnBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/23/%E4%BD%BF%E7%94%A8-Sarama-%E5%BE%80-Kafka-%E5%8F%91%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">使用 Sarama 往 Kafka 发数据</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-23 10:22:18 / 修改时间：10:34:12" itemprop="dateCreated datePublished" datetime="2021-09-23T10:22:18+08:00">2021-09-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">项目实战</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">日志收集</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="使用-Sarama-往-Kafka-发数据"><a href="#使用-Sarama-往-Kafka-发数据" class="headerlink" title="使用 Sarama 往 Kafka 发数据"></a>使用 Sarama 往 Kafka 发数据</h1><h1 id="1-下载、安装-Sarama"><a href="#1-下载、安装-Sarama" class="headerlink" title="1 下载、安装 Sarama"></a>1 下载、安装 Sarama</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/Shopify/sarama </span><br></pre></td></tr></table></figure>

<h1 id="2-Kafka-发数据-Demo"><a href="#2-Kafka-发数据-Demo" class="headerlink" title="2 Kafka 发数据 Demo"></a>2 Kafka 发数据 Demo</h1><h2 id="2-1-配置"><a href="#2-1-配置" class="headerlink" title="2.1 配置"></a>2.1 配置</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config := sarama.NewConfig()</span><br><span class="line">config.Producer.RequiredAcks = sarama.WaitForAll          <span class="comment">// 发送完数据需要leader和follower都确认</span></span><br><span class="line">config.Producer.Partitioner = sarama.NewRandomPartitioner <span class="comment">// 新选出一个partiton</span></span><br><span class="line">config.Producer.Return.Successes = <span class="literal">true</span>                   <span class="comment">// 成功交付的信息将在 success channel 返回</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-构建消息"><a href="#2-2-构建消息" class="headerlink" title="2.2 构建消息"></a>2.2 构建消息</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msg := &amp;sarama.ProducerMessage&#123;&#125;</span><br><span class="line">msg.Topic = <span class="string">&quot;web_log&quot;</span>    <span class="comment">// 主题</span></span><br><span class="line">msg.Value = sarama.StringEncoder(<span class="string">&quot;this is a test log&quot;</span>)    <span class="comment">// 消息内容</span></span><br></pre></td></tr></table></figure>

<h2 id="2-3-连接-Kafka"><a href="#2-3-连接-Kafka" class="headerlink" title="2.3 连接 Kafka"></a>2.3 连接 Kafka</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">client, err := sarama.NewSyncProducer([]<span class="keyword">string</span>&#123;<span class="string">&quot;127.0.0.1:9092&quot;</span>&#125;, config)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;producer closed, err:&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> client.Close()</span><br></pre></td></tr></table></figure>

<h2 id="2-4-发送消息"><a href="#2-4-发送消息" class="headerlink" title="2.4 发送消息"></a>2.4 发送消息</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pid, offset, err := client.SendMessage(msg)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;send msg failed, err:&quot;</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;pid:%v offset:%v\n&quot;</span>, pid, offset)</span><br></pre></td></tr></table></figure>

<h2 id="2-5-消费者"><a href="#2-5-消费者" class="headerlink" title="2.5 消费者"></a>2.5 消费者</h2><p>在 Kafka 安装目录下官方提供了控制台消费者，执行脚本，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh <span class="variable">$KAFKA</span>/bin/kafka-console-consumer.sh --bootstrap-server 127.0.0.1:9092 --topic <span class="string">&quot;web_log&quot;</span> --from-beginning</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/23/%E4%BD%BF%E7%94%A8-Sarama-%E5%BE%80-Kafka-%E5%8F%91%E6%95%B0%E6%8D%AE/kafka_console_consumer.png" alt="img"></p>
<p>然后运行发送消息的程序，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run sarama.go</span><br><span class="line">pid:0 offset:0</span><br></pre></td></tr></table></figure>

<p>可以在控制台窗口看到消费者接收到了消息，</p>
<p><img src="/2021/09/23/%E4%BD%BF%E7%94%A8-Sarama-%E5%BE%80-Kafka-%E5%8F%91%E6%95%B0%E6%8D%AE/msg_received.png" alt="img"></p>
<h1 id="3-完整代码"><a href="#3-完整代码" class="headerlink" title="3 完整代码"></a>3 完整代码</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/Shopify/sarama&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    config := sarama.NewConfig()</span><br><span class="line">    config.Producer.RequiredAcks = sarama.WaitForAll          <span class="comment">// 发送完数据需要leader和follower都确认</span></span><br><span class="line">    config.Producer.Partitioner = sarama.NewRandomPartitioner <span class="comment">// 新选出一个partiton</span></span><br><span class="line">    config.Producer.Return.Successes = <span class="literal">true</span>                   <span class="comment">// 成功交付的信息将在 success channel 返回</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建一个消息</span></span><br><span class="line">    msg := &amp;sarama.ProducerMessage&#123;&#125;</span><br><span class="line">    msg.Topic = <span class="string">&quot;web_log&quot;</span></span><br><span class="line">    msg.Value = sarama.StringEncoder(<span class="string">&quot;this is a test log&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接Kafka</span></span><br><span class="line">    client, err := sarama.NewSyncProducer([]<span class="keyword">string</span>&#123;<span class="string">&quot;127.0.0.1:9092&quot;</span>&#125;, config)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;producer closed, err:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> client.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    pid, offset, err := client.SendMessage(msg)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;send msg failed, err:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;pid:%v offset:%v\n&quot;</span>, pid, offset)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/22/Kafka-%E5%92%8C-Zookeeper-%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lining Hoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hlnBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/22/Kafka-%E5%92%8C-Zookeeper-%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">Kafka 和 Zookeeper 搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-22 17:33:56 / 修改时间：17:42:00" itemprop="dateCreated datePublished" datetime="2021-09-22T17:33:56+08:00">2021-09-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">项目实战</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">日志收集</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kafka-和-Zookeeper-搭建"><a href="#Kafka-和-Zookeeper-搭建" class="headerlink" title="Kafka 和 Zookeeper 搭建"></a>Kafka 和 Zookeeper 搭建</h1><h1 id="1-安装-JDK"><a href="#1-安装-JDK" class="headerlink" title="1 安装 JDK"></a>1 安装 JDK</h1><h2 id="1-1-下载-JDK-压缩包"><a href="#1-1-下载-JDK-压缩包" class="headerlink" title="1.1 下载 JDK 压缩包"></a>1.1 下载 JDK 压缩包</h2><p>下载地址：</p>
<p><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a></p>
<p><img src="/2021/09/22/Kafka-%E5%92%8C-Zookeeper-%E6%90%AD%E5%BB%BA/jdk_dl.png" alt="img"></p>
<h2 id="1-2-解压、移动"><a href="#1-2-解压、移动" class="headerlink" title="1.2 解压、移动"></a>1.2 解压、移动</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 解压</span><br><span class="line">tar -xzvf jdk-8u301-linux-x64.tar.gz</span><br><span class="line"># 移动文件夹</span><br><span class="line">sudo mv jdk1.8.0_301/ /opt/jdk8</span><br></pre></td></tr></table></figure>

<h2 id="1-3-配置-JDK-环境变量"><a href="#1-3-配置-JDK-环境变量" class="headerlink" title="1.3 配置 JDK 环境变量"></a>1.3 配置 JDK 环境变量</h2><p>在 ~/.bashrc 文件末尾添加以下几行，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/opt/jdk8</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar                                                       </span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br></pre></td></tr></table></figure>

<p>使环境变量生效，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="2-下载-Kafka-压缩包、解压、移动"><a href="#2-下载-Kafka-压缩包、解压、移动" class="headerlink" title="2 下载 Kafka 压缩包、解压、移动"></a>2 下载 Kafka 压缩包、解压、移动</h1><h2 id="2-1-下载-Kafka-压缩包"><a href="#2-1-下载-Kafka-压缩包" class="headerlink" title="2.1 下载 Kafka 压缩包"></a>2.1 下载 Kafka 压缩包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dlcdn.apache.org/kafka/3.0.0/kafka_2.13-3.0.0.tgz</span><br></pre></td></tr></table></figure>

<h2 id="2-2-解压"><a href="#2-2-解压" class="headerlink" title="2.2 解压"></a>2.2 解压</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf kafka_2.13-3.0.0.tgz</span><br></pre></td></tr></table></figure>

<h2 id="2-3-移动文件夹"><a href="#2-3-移动文件夹" class="headerlink" title="2.3 移动文件夹"></a>2.3 移动文件夹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mv kafka_2.13-3.0.0 /opt/kafka</span><br></pre></td></tr></table></figure>

<h2 id="2-4-配置环境变量"><a href="#2-4-配置环境变量" class="headerlink" title="2.4 配置环境变量"></a>2.4 配置环境变量</h2><p>在 ~/.bashrc 文件末尾添加以下几行，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export KAFKA=/opt/kafka</span><br><span class="line">export PATH=$PATH:$KAFKA/bin </span><br></pre></td></tr></table></figure>

<p>使环境变量生效，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="3-运行-Kafka"><a href="#3-运行-Kafka" class="headerlink" title="3 运行 Kafka"></a>3 运行 Kafka</h1><h2 id="3-1-启动-Zookeeper"><a href="#3-1-启动-Zookeeper" class="headerlink" title="3.1 启动 Zookeeper"></a>3.1 启动 Zookeeper</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zookeeper-server-start.sh $KAFKA/config/zookeeper.properties</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/22/Kafka-%E5%92%8C-Zookeeper-%E6%90%AD%E5%BB%BA/zookeeper_start.png" alt="img"></p>
<h2 id="3-2-启动-Kafka"><a href="#3-2-启动-Kafka" class="headerlink" title="3.2 启动 Kafka"></a>3.2 启动 Kafka</h2><p>另外打开一个终端窗口，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kafka-server-start.sh $KAFKA/config/server.properties</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/22/Kafka-%E5%92%8C-Zookeeper-%E6%90%AD%E5%BB%BA/kafka_start.png" alt="img"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/22/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lining Hoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hlnBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/22/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">日志收集项目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-22 14:31:51 / 修改时间：15:06:01" itemprop="dateCreated datePublished" datetime="2021-09-22T14:31:51+08:00">2021-09-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">项目实战</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">日志收集</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="日志收集项目"><a href="#日志收集项目" class="headerlink" title="日志收集项目"></a>日志收集项目</h1><h1 id="1-项目背景"><a href="#1-项目背景" class="headerlink" title="1 项目背景"></a>1 项目背景</h1><p>每个业务系统都有日志，当系统出现问题时，需要通过日志信息定位和解决问题。当系统机器比较少时，登录到服务器上查看即可。当系统机器规模巨大，登录到机器上查看⼏乎不现实（分布式的系 统，⼀个系统部署在十几台机器上）。</p>
<h1 id="2-解决方案"><a href="#2-解决方案" class="headerlink" title="2 解决方案"></a>2 解决方案</h1><p>把机器上的⽇志实时收集，统⼀的存储到中⼼系统。 在对这些⽇志建⽴索引，通过搜索即可快速找到对 应的⽇志记录 通过提供⼀个界⾯友好的web⻚⾯实现⽇志检索与展示。</p>
<h1 id="3-面临的问题"><a href="#3-面临的问题" class="headerlink" title="3 面临的问题"></a>3 面临的问题</h1><p>实时⽇质量⾮常⼤，每天处理几十亿条。 ⽇志准实时收集，延迟控制在分钟级别。 能够⽀持水平扩 展。</p>
<h1 id="4-架构设计"><a href="#4-架构设计" class="headerlink" title="4 架构设计"></a>4 架构设计</h1><p><img src="/2021/09/22/%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%A1%B9%E7%9B%AE/arch.jpg" alt="项目架构"></p>
<ul>
<li>LogAgent：⽇志收集客户端，⽤来收集服务器上的日志</li>
<li>Kafka：⾼吞吐量的分布式队列</li>
<li> ElasticSearch：开源的搜索引擎，提供基于HTTP RESTful的web接口</li>
<li>Kibaba：开源的ES数据分析和可视化⼯具</li>
<li>Hadoop：分布式计算框架，能够对⼤量数据进行分布式处理的平台</li>
<li>Storm：⼀个免费并开源的分布式实时计算系统</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/20/%E9%80%9A%E7%9F%A5%E5%AD%90-goroutine-%E9%80%80%E5%87%BA%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lining Hoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hlnBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/20/%E9%80%9A%E7%9F%A5%E5%AD%90-goroutine-%E9%80%80%E5%87%BA%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">通知子 goroutine 退出的三种方式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-20 11:09:47" itemprop="dateCreated datePublished" datetime="2021-09-20T11:09:47+08:00">2021-09-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-21 16:16:04" itemprop="dateModified" datetime="2021-09-21T16:16:04+08:00">2021-09-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="通知子-goroutine-退出的三种方式"><a href="#通知子-goroutine-退出的三种方式" class="headerlink" title="通知子 goroutine 退出的三种方式"></a>通知子 goroutine 退出的三种方式</h1><h1 id="1-全局变量"><a href="#1-全局变量" class="headerlink" title="1 全局变量"></a>1 全局变量</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> exit <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;worker&quot;</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        <span class="keyword">if</span> exit &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> worker()</span><br><span class="line">    time.Sleep(time.Second * <span class="number">5</span>)</span><br><span class="line">    exit = <span class="literal">true</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义全局变量 <strong>exit</strong> 用于表示是否要求子 goroutine 退出</li>
<li>父 goroutine 中设置全局变量 <strong>exit</strong> 的值 </li>
<li>子 goroutine 中循环检测全局变量 <strong>exit</strong> 的值，如果为 true，则结束这个子 goroutine</li>
</ul>
<h1 id="2-Channel"><a href="#2-Channel" class="headerlink" title="2 Channel"></a>2 Channel</h1><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">LOOP:</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;worker&quot;</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-exitChan:</span><br><span class="line">            <span class="keyword">break</span> LOOP</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 注意：如果没有default，select会阻塞在等待exitChan有值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> exitChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(exitChan)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">    exitChan &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    <span class="built_in">close</span>(exitChan)</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>定义无缓冲的管道 <strong>exitChan</strong> 用于表示是否要求子 goroutine 退出</li>
<li><strong>select</strong> 多路复用，监听管道 exitChan 中是否有值。如果有值就结束子 goroutine；如果没有值，就执行默认操作</li>
<li>注意：如果没有default，select会阻塞在等待<strong>exitChan</strong>有值，因为这里定义的管道是无缓冲的</li>
</ul>
<h1 id="3-Context"><a href="#3-Context" class="headerlink" title="3 Context"></a>3 Context</h1><h2 id="3-1-context-WithCancel"><a href="#3-1-context-WithCancel" class="headerlink" title="3.1 context.WithCancel"></a>3.1 context.WithCancel</h2><h3 id="3-1-1-开启1个子goroutine"><a href="#3-1-1-开启1个子goroutine" class="headerlink" title="3.1.1 开启1个子goroutine"></a>3.1.1 开启1个子goroutine</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">LOOP:</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;worker&quot;</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">break</span> LOOP</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 注意：如果没有default，select会阻塞在等待ctx.Done()有值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">    cancel() <span class="comment">// 通知子 goroutine 结束</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>context.WithCancel</strong> 函数返回父context的子context，和一个函数对象cancel用于通知子goroutine结束</li>
<li>context内部维护了一个管道，context对象ctx调用<strong>Done</strong>方法，返回只读形式的管道</li>
<li>子goroutine中select多路复用，监听管道ctx.Done。如果有值，则结束子goroutine；否则，执行默认操作</li>
<li>调用 cancel 函数对象，通知子goroutine结束</li>
</ul>
<h3 id="3-1-2-开启多个子goroutine"><a href="#3-1-2-开启多个子goroutine" class="headerlink" title="3.1.2 开启多个子goroutine"></a>3.1.2 开启多个子goroutine</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">workerGroup</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">LOOP:</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;worker&quot;</span>)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">break</span> LOOP</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 注意：如果没有default，select会阻塞在等待ctx.Done()有值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> workerGroup(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">    cancel() <span class="comment">// 通知子 goroutine 结束</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<strong>context</strong>可以很方便地处理通知多个子goroutine结束的情况</li>
</ul>
<h2 id="3-2-context-WithDeadline"><a href="#3-2-context-WithDeadline" class="headerlink" title="3.2 context.WithDeadline"></a>3.2 context.WithDeadline</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">LOOP:</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;worker&quot;</span>)</span><br><span class="line">        time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">break</span> LOOP</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 注意：如果没有default，select会阻塞在等待exitChan有值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    deadline := time.Now().Add(time.Millisecond * <span class="number">50</span>)</span><br><span class="line">    ctx, cancel := context.WithDeadline(context.Background(), deadline)</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">    cancel() <span class="comment">// 通知子 goroutine 结束</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码，定义了一个50ms过期的deadline</li>
<li>调用context.WithDeadline函数，得到子上下文ctx，和一个取消函数cancel</li>
<li>子goroutine中select多路复用，监听管道ctx.Done。如果有值，则结束子goroutine；否则，执行默认操作</li>
<li>两种情况会向管道 ctx.Done 中发送结束信号：① 截止时间到，ctx对象自动向内部维护的管道发送结束信号 ② 手动调用 cancel 函数，通知子 goroutine 结束</li>
</ul>
<h2 id="3-3-context-WithTimeout"><a href="#3-3-context-WithTimeout" class="headerlink" title="3.3 context.WithTimeout"></a>3.3 context.WithTimeout</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">LOOP:</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;worker&quot;</span>)</span><br><span class="line">        time.Sleep(time.Millisecond * <span class="number">10</span>)</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            <span class="keyword">break</span> LOOP</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// 注意：如果没有default，select会阻塞在等待exitChan有值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), time.Millisecond*<span class="number">50</span>)</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> worker(ctx)</span><br><span class="line">    time.Sleep(time.Second * <span class="number">3</span>)</span><br><span class="line">    cancel() <span class="comment">// 通知子 goroutine 结束</span></span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(<span class="string">&quot;over&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用context.WithTimeout函数，指定超时时间，得到子上下文ctx，和一个取消函数cancel</li>
<li>子goroutine中select多路复用，监听管道ctx.Done。如果有值，则结束子goroutine；否则，执行默认操作</li>
<li>两种情况会向管道 ctx.Done 中发送结束信号：① 超时时间到，ctx对象自动向内部维护的管道发送结束信号 ② 手动调用 cancel 函数，通知子 goroutine 结束</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/19/MongoDB-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lining Hoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hlnBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/19/MongoDB-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">MongoDB 学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-19 17:53:29" itemprop="dateCreated datePublished" datetime="2021-09-19T17:53:29+08:00">2021-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-21 16:06:04" itemprop="dateModified" datetime="2021-09-21T16:06:04+08:00">2021-09-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="MongoDB-学习笔记"><a href="#MongoDB-学习笔记" class="headerlink" title="MongoDB 学习笔记"></a>MongoDB 学习笔记</h1><h1 id="1-MongoDB-简介"><a href="#1-MongoDB-简介" class="headerlink" title="1 MongoDB 简介"></a>1 MongoDB 简介</h1><h2 id="1-1-数据库的分类"><a href="#1-1-数据库的分类" class="headerlink" title="1.1 数据库的分类"></a>1.1 数据库的分类</h2><h3 id="1-1-1-关系型数据库（RDBMS）"><a href="#1-1-1-关系型数据库（RDBMS）" class="headerlink" title="1.1.1 关系型数据库（RDBMS）"></a>1.1.1 关系型数据库（RDBMS）</h3><ul>
<li>MySQL、Oracle、SQL Server、DB2 ……</li>
<li>关系数据库中全部是表（所谓“关系”，通俗点说就是二维表）</li>
</ul>
<h3 id="1-1-2-非关系型数据库（NoSQL）"><a href="#1-1-2-非关系型数据库（NoSQL）" class="headerlink" title="1.1.2 非关系型数据库（NoSQL）"></a>1.1.2 非关系型数据库（NoSQL）</h3><ul>
<li>NoSQL是Not Only SQL的缩写，“不仅仅是SQL”</li>
<li>Redis：键值对数据库，常用作缓存</li>
<li>MongoDB：文档数据库</li>
</ul>
<h2 id="1-2-MongoDB-概述"><a href="#1-2-MongoDB-概述" class="headerlink" title="1.2 MongoDB 概述"></a>1.2 MongoDB 概述</h2><p>MongoDB 的数据模型是<strong>面向文档</strong>的，所谓文档是一种类似于JSON的结构，简单理解 MongoDB 数据库中存的是各种各样的JSON（BSON）。</p>
<h1 id="2-MongoDB-安装"><a href="#2-MongoDB-安装" class="headerlink" title="2 MongoDB 安装"></a>2 MongoDB 安装</h1><h2 id="2-1-安装依赖包"><a href="#2-1-安装依赖包" class="headerlink" title="2.1 安装依赖包"></a>2.1 安装依赖包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libcurl3 openssl</span><br></pre></td></tr></table></figure>

<h2 id="2-2-下载、解压、移动文件"><a href="#2-2-下载、解压、移动文件" class="headerlink" title="2.2 下载、解压、移动文件"></a>2.2 下载、解压、移动文件</h2><ul>
<li>MongoDB 下载地址：<a target="_blank" rel="noopener" href="https://www.mongodb.com/try/download">Try MongoDB Products | MongoDB</a></li>
<li>下载压缩包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-debian92-5.0.2.tgz</span><br></pre></td></tr></table></figure>

<ul>
<li>解压</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf mongodb-linux-x86_64-debian92-5.0.2.tgz</span><br></pre></td></tr></table></figure>

<ul>
<li>移动文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv mongodb-linux-x86_64-debian92-5.0.2 /opt/mongodb</span><br></pre></td></tr></table></figure>

<h2 id="2-3-配置环境变量"><a href="#2-3-配置环境变量" class="headerlink" title="2.3 配置环境变量"></a>2.3 配置环境变量</h2><p>在 ~/.bashrc 文件中添加一行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/mongodb/bin</span><br></pre></td></tr></table></figure>

<p>使环境变量生效，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="3-MongoDB-服务启动、停止"><a href="#3-MongoDB-服务启动、停止" class="headerlink" title="3 MongoDB 服务启动、停止"></a>3 MongoDB 服务启动、停止</h1><h2 id="3-1-前台启动"><a href="#3-1-前台启动" class="headerlink" title="3.1 前台启动"></a>3.1 前台启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath &lt;数据存储目录&gt;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-后台启动"><a href="#3-2-后台启动" class="headerlink" title="3.2 后台启动"></a>3.2 后台启动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath &lt;数据存储目录&gt; --logpath &lt;日志文件路径&gt; --fork</span><br></pre></td></tr></table></figure>

<h2 id="3-3-停止服务"><a href="#3-3-停止服务" class="headerlink" title="3.3 停止服务"></a>3.3 停止服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath &lt;数据存储目录&gt; --logpath &lt;日志文件路径&gt; --shutdown</span><br></pre></td></tr></table></figure>

<h1 id="4-基本使用"><a href="#4-基本使用" class="headerlink" title="4 基本使用"></a>4 基本使用</h1><h2 id="4-1-数据库对象"><a href="#4-1-数据库对象" class="headerlink" title="4.1 数据库对象"></a>4.1 数据库对象</h2><ul>
<li>数据库：是一个仓库，可以存放多个集合。</li>
<li>集合：类似于数组，可以存放多个文档。</li>
<li>文档：数据库中的最小单位，我们存储和操作的内容都是文档。</li>
</ul>
<h2 id="4-2-常用命令"><a href="#4-2-常用命令" class="headerlink" title="4.2 常用命令"></a>4.2 常用命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>show databases</td>
<td>显示所有的数据库</td>
</tr>
<tr>
<td>use &lt;数据库名&gt;</td>
<td>切换数据库（支持自动创建数据库）</td>
</tr>
<tr>
<td>db</td>
<td>显示当前所处的数据库</td>
</tr>
<tr>
<td>show collections</td>
<td>显示当前数据库中所有的集合</td>
</tr>
<tr>
<td>db.&lt;集合名&gt;.insert(&lt;文档内容&gt;)</td>
<td>向集合中插入文档</td>
</tr>
<tr>
<td>db.&lt;集合名&gt;.find()</td>
<td>查询集合中的文档</td>
</tr>
</tbody></table>
<h1 id="5-CRUD"><a href="#5-CRUD" class="headerlink" title="5 CRUD"></a>5 CRUD</h1><h2 id="5-1-插入文档"><a href="#5-1-插入文档" class="headerlink" title="5.1 插入文档"></a>5.1 插入文档</h2><h3 id="5-1-1-ObjectId"><a href="#5-1-1-ObjectId" class="headerlink" title="5.1.1 ObjectId"></a>5.1.1 ObjectId</h3><ul>
<li>当插入文档时，如果没有显式地给出 <strong>“_id”</strong> 字段值，则 MongoDB 会自动为文档生成一个独一无二的 <strong>“_id”</strong> 字段值。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6141e9058a2bd158b67c5a70&quot;</span>), <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;孙悟空&quot;</span>, <span class="attr">&quot;age&quot;</span> : <span class="number">500</span>, <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;齐天大圣，唐僧的徒弟&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-1-2-insert"><a href="#5-1-2-insert" class="headerlink" title="5.1.2 insert"></a>5.1.2 insert</h3><ul>
<li>在集合中插入一个或多个文档</li>
<li>以 <strong>json 对象</strong>的形式插入一个文档</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.insert(&#123;<span class="attr">name</span>:<span class="string">&quot;孙悟空&quot;</span>, <span class="attr">age</span>:<span class="number">500</span>, <span class="attr">description</span>:<span class="string">&quot;齐天大圣，唐僧的徒弟&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>以 <strong>json 对象数组</strong>的形式插入多个文档</li>
</ul>
<p>命令，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.insert([&#123;<span class="attr">name</span>:<span class="string">&quot;猪八戒&quot;</span>, <span class="attr">age</span>:<span class="number">300</span>, <span class="attr">description</span>:<span class="string">&quot;天蓬元帅&quot;</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">&quot;沙悟净&quot;</span>, <span class="attr">age</span>:<span class="number">200</span>, <span class="attr">description</span>:<span class="string">&quot;卷帘大将&quot;</span>&#125;]); </span><br></pre></td></tr></table></figure>

<p>返回，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BulkWriteResult(&#123;    </span><br><span class="line">    <span class="attr">&quot;writeErrors&quot;</span> : [ ],   </span><br><span class="line">    <span class="attr">&quot;writeConcernErrors&quot;</span> : [ ],                                                                                                 <span class="attr">&quot;writeConcernErrors&quot;</span> : [ ],                                                                                                             <span class="attr">&quot;writeErrors&quot;</span> : [ ],                                                                                                    <span class="attr">&quot;writeConcernErrors&quot;</span> : [ ],                                                                                             </span><br><span class="line">    <span class="attr">&quot;nInserted&quot;</span> : <span class="number">2</span>,                                                                                                        </span><br><span class="line">    <span class="attr">&quot;nUpserted&quot;</span> : <span class="number">0</span>,                                                                                                       </span><br><span class="line">    <span class="attr">&quot;nMatched&quot;</span> : <span class="number">0</span>,                                                                                                        </span><br><span class="line">    <span class="attr">&quot;nModified&quot;</span> : <span class="number">0</span>,                                                                                                        </span><br><span class="line">    <span class="attr">&quot;nRemoved&quot;</span> : <span class="number">0</span>,                                                                                                         </span><br><span class="line">    <span class="attr">&quot;upserted&quot;</span> : [ ]                                                                                               </span><br><span class="line"> &#125;) </span><br></pre></td></tr></table></figure>

<h3 id="5-1-3-insertOne"><a href="#5-1-3-insertOne" class="headerlink" title="5.1.3 insertOne"></a>5.1.3 insertOne</h3><ul>
<li>在集合中插入一个文档</li>
</ul>
<p>命令，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.insertOne(&#123;<span class="attr">name</span>:<span class="string">&quot;唐僧&quot;</span>, <span class="attr">age</span>: <span class="number">800</span>, <span class="attr">description</span>:<span class="string">&quot;金蝉子&quot;</span>&#125;); </span><br></pre></td></tr></table></figure>

<p>返回，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;                                                                                                                               </span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span> : <span class="literal">true</span>,                                                                                                  </span><br><span class="line">    <span class="attr">&quot;insertedId&quot;</span> : ObjectId(<span class="string">&quot;61420315cb3a9ab2eb5a6975&quot;</span>)                                                             </span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>

<h3 id="5-1-4-insertMany"><a href="#5-1-4-insertMany" class="headerlink" title="5.1.4 insertMany"></a>5.1.4 insertMany</h3><ul>
<li>在集合中插入多个文档</li>
</ul>
<p>命令，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.insertMany([&#123;<span class="attr">name</span>:<span class="string">&quot;蜘蛛精&quot;</span>, <span class="attr">age</span>:<span class="number">400</span>, <span class="attr">description</span>:<span class="string">&quot;妖精&quot;</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">&quot;白骨精&quot;</span>, <span class="attr">age</span>:<span class="number">300</span>, <span class="attr">description</span>:<span class="string">&quot;妖精&quot;</span>&#125;]);  </span><br></pre></td></tr></table></figure>

<p>返回，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;                                                                                                                               </span><br><span class="line">    <span class="attr">&quot;acknowledged&quot;</span> : <span class="literal">true</span>,                                                                                                  </span><br><span class="line">    <span class="attr">&quot;insertedIds&quot;</span> : [    </span><br><span class="line">          ObjectId(<span class="string">&quot;614206cec4c4d45fc611c481&quot;</span>),   </span><br><span class="line">          ObjectId(<span class="string">&quot;614206cec4c4d45fc611c482&quot;</span>)                                                                                ObjectId(<span class="string">&quot;614206cec4c4d45fc611c482&quot;</span>)                                                                                                     ObjectId(<span class="string">&quot;614206cec4c4d45fc611c481&quot;</span>),                                                                                   ObjectId(<span class="string">&quot;614206cec4c4d45fc611c482&quot;</span>)                                                                            </span><br><span class="line">    ]                                                                                                              </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="5-2-查询文档"><a href="#5-2-查询文档" class="headerlink" title="5.2 查询文档"></a>5.2 查询文档</h2><h3 id="5-2-1-db-collection-find"><a href="#5-2-1-db-collection-find" class="headerlink" title="5.2.1 db.collection.find"></a>5.2.1 db.collection.find</h3><ul>
<li>查询集合中符合条件的文档，返回的是一个结果<strong>数组</strong></li>
<li>传入一个对象作为筛选条件</li>
<li>例如：</li>
</ul>
<p>查询，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.find(&#123;<span class="attr">age</span>:<span class="number">300</span>&#125;) </span><br></pre></td></tr></table></figure>

<p>   返回，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6142027bcb3a9ab2eb5a6973&quot;</span>), <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;猪八戒&quot;</span>, <span class="attr">&quot;age&quot;</span> : <span class="number">300</span>, <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;天蓬元帅&quot;</span> &#125;            </span><br><span class="line">&#123; <span class="attr">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;614206cec4c4d45fc611c482&quot;</span>), <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;白骨精&quot;</span>, <span class="attr">&quot;age&quot;</span> : <span class="number">300</span>, <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;妖精&quot;</span> &#125;   </span><br></pre></td></tr></table></figure>

<h3 id="5-2-2-db-collection-findOne"><a href="#5-2-2-db-collection-findOne" class="headerlink" title="5.2.2 db.collection.findOne"></a>5.2.2 db.collection.findOne</h3><ul>
<li>查询集合中符合条件的第一个文档，返回的是一个<strong>对象</strong></li>
<li>例如：</li>
</ul>
<p>查询，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.findOne(&#123;<span class="attr">age</span>:<span class="number">300</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>返回，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;                                                                                                                               </span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6142027bcb3a9ab2eb5a6973&quot;</span>),                                                                           <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;猪八戒&quot;</span>,                                                                                                     </span><br><span class="line">     <span class="attr">&quot;age&quot;</span> : <span class="number">300</span>,                                                                                                            </span><br><span class="line">    <span class="attr">&quot;description&quot;</span> : <span class="string">&quot;天蓬元帅&quot;</span>                                                                                     </span><br><span class="line"> &#125;   </span><br></pre></td></tr></table></figure>

<h3 id="5-2-3-db-collection-find-count"><a href="#5-2-3-db-collection-find-count" class="headerlink" title="5.2.3 db.collection.find.count"></a>5.2.3 db.collection.find.count</h3><ul>
<li>查询集合中所有符合条件文档的数量</li>
<li>例如：</li>
</ul>
<p>查询，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.npc.find(&#123;<span class="attr">age</span>:<span class="number">300</span>&#125;).count()</span><br></pre></td></tr></table></figure>

<p>返回，</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-修改文档"><a href="#5-3-修改文档" class="headerlink" title="5.3 修改文档"></a>5.3 修改文档</h2><h3 id="5-3-1-db-collection-update"><a href="#5-3-1-db-collection-update" class="headerlink" title="5.3.1 db.collection.update"></a>5.3.1 db.collection.update</h3><ul>
<li>语法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.&lt;集合名&gt;.update(&lt;查询条件&gt;, &lt;修改/新对象&gt;, &lt;选项&gt;)</span><br></pre></td></tr></table></figure>

<ul>
<li>默认情况下，会使用新对象来<strong>替换</strong>旧对象，注意：新对象<strong>直接替换</strong>旧对象，不保留原对象的值。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.npc.update(&#123;<span class="attr">age</span>:<span class="number">300</span>&#125;, &#123;<span class="attr">name</span>:<span class="string">&quot;猪八戒&quot;</span>, <span class="attr">age</span>:<span class="number">300</span>, <span class="attr">address</span>:<span class="string">&quot;高老庄&quot;</span>&#125;)</span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : <span class="number">1</span>, <span class="string">&quot;nUpserted&quot;</span> : <span class="number">0</span>, <span class="string">&quot;nModified&quot;</span> : <span class="number">1</span> &#125;) </span><br><span class="line">&gt; db.npc.find(&#123;<span class="attr">age</span>:<span class="number">300</span>&#125;)  </span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6142027bcb3a9ab2eb5a6973&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;猪八戒&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="number">300</span>, <span class="string">&quot;address&quot;</span> : <span class="string">&quot;高老庄&quot;</span> &#125;           </span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;614206cec4c4d45fc611c482&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;白骨精&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="number">300</span>, <span class="string">&quot;description&quot;</span> : <span class="string">&quot;妖精&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果需要修改指定的属性，使用 $set </li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.npc.update(&#123;<span class="attr">name</span>:<span class="string">&quot;猪八戒&quot;</span>&#125;, &#123;<span class="attr">$set</span>:&#123;<span class="attr">description</span>:<span class="string">&quot;天蓬元帅&quot;</span>&#125;&#125;)   </span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : <span class="number">1</span>, <span class="string">&quot;nUpserted&quot;</span> : <span class="number">0</span>, <span class="string">&quot;nModified&quot;</span> : <span class="number">1</span> &#125;)</span><br><span class="line">&gt; db.npc.find(&#123;<span class="attr">name</span>:<span class="string">&quot;猪八戒&quot;</span>&#125;) </span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6142027bcb3a9ab2eb5a6973&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;猪八戒&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="number">300</span>, <span class="string">&quot;address&quot;</span> : <span class="string">&quot;高老庄&quot;</span>, <span class="string">&quot;description&quot;</span> : <span class="string">&quot;天蓬元帅&quot;</span> &#125;     </span><br></pre></td></tr></table></figure>

<ul>
<li>如果需要删除指定的属性，使用 $unset</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.npc.update(&#123;<span class="attr">name</span>:<span class="string">&quot;猪八戒&quot;</span>&#125;, &#123;<span class="attr">$unset</span>:&#123;<span class="attr">address</span>:<span class="string">&quot;&quot;</span>&#125;&#125;) </span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : <span class="number">1</span>, <span class="string">&quot;nUpserted&quot;</span> : <span class="number">0</span>, <span class="string">&quot;nModified&quot;</span> : <span class="number">1</span> &#125;) </span><br><span class="line">&gt; db.npc.find(&#123;<span class="attr">name</span>:<span class="string">&quot;猪八戒&quot;</span>&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;6142027bcb3a9ab2eb5a6973&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;猪八戒&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="number">300</span>, <span class="string">&quot;description&quot;</span> : <span class="string">&quot;天蓬元帅&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>update 默认只会修改一个，设置选项 <strong>multi: true</strong>，可支持修改多个文档对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; db.npc.update(&#123;<span class="attr">description</span>:<span class="string">&quot;妖精&quot;</span>&#125;, &#123;<span class="attr">$set</span>:&#123;<span class="attr">gender</span>:<span class="string">&quot;女&quot;</span>&#125;&#125;, &#123;<span class="attr">multi</span>:<span class="literal">true</span>&#125;)   </span><br><span class="line">WriteResult(&#123; <span class="string">&quot;nMatched&quot;</span> : <span class="number">2</span>, <span class="string">&quot;nUpserted&quot;</span> : <span class="number">0</span>, <span class="string">&quot;nModified&quot;</span> : <span class="number">2</span> &#125;)</span><br><span class="line">&gt; db.npc.find(&#123;<span class="attr">description</span>:<span class="string">&quot;妖精&quot;</span>&#125;)</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;614206cec4c4d45fc611c481&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;蜘蛛精&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="number">400</span>, <span class="string">&quot;description&quot;</span> : <span class="string">&quot;妖精&quot;</span>, <span class="string">&quot;gender&quot;</span> : <span class="string">&quot;女&quot;</span> &#125;</span><br><span class="line">&#123; <span class="string">&quot;_id&quot;</span> : ObjectId(<span class="string">&quot;614206cec4c4d45fc611c482&quot;</span>), <span class="string">&quot;name&quot;</span> : <span class="string">&quot;白骨精&quot;</span>, <span class="string">&quot;age&quot;</span> : <span class="number">300</span>, <span class="string">&quot;description&quot;</span> : <span class="string">&quot;妖精&quot;</span>, <span class="string">&quot;gender&quot;</span> : <span class="string">&quot;女&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-2-db-collection-updateMany"><a href="#5-3-2-db-collection-updateMany" class="headerlink" title="5.3.2 db.collection.updateMany"></a>5.3.2 db.collection.updateMany</h3><ul>
<li>同时修改多个符合条件的文档</li>
<li>相当于 update 设置选项 <strong>multi: true</strong></li>
</ul>
<h3 id="5-3-3-db-collection-updateOne"><a href="#5-3-3-db-collection-updateOne" class="headerlink" title="5.3.3 db.collection.updateOne"></a>5.3.3 db.collection.updateOne</h3><ul>
<li>修改一个符合条件的文档</li>
<li>update 默认</li>
</ul>
<h3 id="5-3-4-db-collection-replaceOne"><a href="#5-3-4-db-collection-replaceOne" class="headerlink" title="5.3.4 db.collection.replaceOne"></a>5.3.4 db.collection.replaceOne</h3><ul>
<li><strong>替换</strong>一个符合条件的文档</li>
</ul>
<h2 id="5-4-删除文档"><a href="#5-4-删除文档" class="headerlink" title="5.4 删除文档"></a>5.4 删除文档</h2><h3 id="5-4-1-db-collection-remove"><a href="#5-4-1-db-collection-remove" class="headerlink" title="5.4.1 db.collection.remove"></a>5.4.1 db.collection.remove</h3><ul>
<li>语法</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">db.collection.remove(   </span><br><span class="line">    &lt;query&gt;,   </span><br><span class="line">    &lt;justOne&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>根据条件来删除文档，传递条件的方式和 find() 一样</li>
<li>默认情况下会删除多个</li>
<li>第二个参数传递 true，则只会删除一个</li>
</ul>
<h3 id="5-4-2-db-collection-deleteOne"><a href="#5-4-2-db-collection-deleteOne" class="headerlink" title="5.4.2 db.collection.deleteOne"></a>5.4.2 db.collection.deleteOne</h3><ul>
<li>删除一个符合条件的文档</li>
</ul>
<h3 id="5-4-3-db-collection-deleteMany"><a href="#5-4-3-db-collection-deleteMany" class="headerlink" title="5.4.3 db.collection.deleteMany"></a>5.4.3 db.collection.deleteMany</h3><ul>
<li>删除多个符合条件的文档</li>
</ul>
<h3 id="5-4-4-db-collection-drop"><a href="#5-4-4-db-collection-drop" class="headerlink" title="5.4.4 db.collection.drop"></a>5.4.4 db.collection.drop</h3><ul>
<li>删除集合</li>
</ul>
<h3 id="5-4-5-db-dropDatabase"><a href="#5-4-5-db-dropDatabase" class="headerlink" title="5.4.5 db.dropDatabase"></a>5.4.5 db.dropDatabase</h3><ul>
<li>删除数据库</li>
</ul>
<h2 id="5-5-sort、limit、skip"><a href="#5-5-sort、limit、skip" class="headerlink" title="5.5 sort、limit、skip"></a>5.5 sort、limit、skip</h2><h3 id="5-5-1-sort"><a href="#5-5-1-sort" class="headerlink" title="5.5.1 sort"></a>5.5.1 sort</h3><ul>
<li>查询文档时，默认情况是按照 _id 的值进行排列（升序） </li>
<li>sort 可以用来指定文档排序的规则</li>
<li>需要传递一个对象用来指定排序的规则，1 表示升序，-1 表示降序</li>
<li>例如 employee 对象中有一字段 salary，要求按照工资升序排列，</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.employees.find().sort(&#123;<span class="attr">salary</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="5-5-2-limit"><a href="#5-5-2-limit" class="headerlink" title="5.5.2 limit"></a>5.5.2 limit</h3><ul>
<li>取出集合中前 n 个文档</li>
<li>例如，查询职工表中前两个职工，</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.employees.find().limit(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-5-3-skip"><a href="#5-5-3-skip" class="headerlink" title="5.5.3 skip"></a>5.5.3 skip</h3><ul>
<li>跳过集合中前 n 个文档</li>
<li>例如，查询职工表中从第 3 个开始的所有职工，</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.employees.find().skip(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h3 id="5-5-4-调用顺序"><a href="#5-5-4-调用顺序" class="headerlink" title="5.5.4 调用顺序"></a>5.5.4 调用顺序</h3><ul>
<li>以上三个函数可以组合使用，代码中 sort、limit、skip 的顺序可以任意调换，但是实际执行的顺序依次是：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sort    =&gt;    skip    =&gt;    limit</span><br></pre></td></tr></table></figure>

<h2 id="5-6-投影"><a href="#5-6-投影" class="headerlink" title="5.6 投影"></a>5.6 投影</h2><ul>
<li>查询时，可以在第二个参数位置来设置查询结果的投影</li>
<li>例如，查询所有职工的姓名和工资，</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.employees.find(&#123;&#125;, &#123;<span class="attr">name</span>:<span class="number">1</span>, <span class="attr">salary</span>:<span class="number">1</span>&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>默认情况下，会显示 _id 字段，可设置 <strong>_id: 0</strong> 去除</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.employees.find(&#123;&#125;, &#123;<span class="attr">name</span>:<span class="number">1</span>, <span class="attr">salary</span>:<span class="number">1</span>, <span class="attr">_id</span>:<span class="number">0</span>&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="6-文档之间的关系"><a href="#6-文档之间的关系" class="headerlink" title="6 文档之间的关系"></a>6 文档之间的关系</h1><h2 id="6-1-一对一"><a href="#6-1-一对一" class="headerlink" title="6.1 一对一"></a>6.1 一对一</h2><ul>
<li>使用内嵌文档的形式表示，其实就是在其中一个文档中加一个引用字段</li>
</ul>
<h2 id="6-2-一对多"><a href="#6-2-一对多" class="headerlink" title="6.2 一对多"></a>6.2 一对多</h2><ul>
<li>开发中常见的关系，例子：</li>
</ul>
<table>
<thead>
<tr>
<th>1</th>
<th>n</th>
</tr>
</thead>
<tbody><tr>
<td>父亲</td>
<td>孩子</td>
</tr>
<tr>
<td>用户</td>
<td>订单</td>
</tr>
<tr>
<td>文章</td>
<td>评论</td>
</tr>
</tbody></table>
<ul>
<li>也可以通过内嵌文档的形式映射一对多的关系，比如在订单表中加一个字段，指向用户表中的某一个用户</li>
<li>通常是在 <strong>“多” 的一方</strong>的表中加一个字段</li>
</ul>
<h2 id="6-3-多对多"><a href="#6-3-多对多" class="headerlink" title="6.3 多对多"></a>6.3 多对多</h2><ul>
<li>新建一个文档用来表示多对多的关系，字段是关系双方的 id</li>
<li>例如，学生和选课是多对多的关系，一个学生可以选择多门课，一个课程可以被多个学生选，存在课程表和学生表，则选课关系如下：</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>course_id</th>
<th>student_id</th>
</tr>
</thead>
</table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/08/Thrift-IDL-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Lining Hoo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hlnBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/08/Thrift-IDL-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Thrift IDL 学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-08 12:02:58" itemprop="dateCreated datePublished" datetime="2021-09-08T12:02:58+08:00">2021-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-21 16:36:38" itemprop="dateModified" datetime="2021-09-21T16:36:38+08:00">2021-09-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Thrift-IDL-学习笔记"><a href="#Thrift-IDL-学习笔记" class="headerlink" title="Thrift IDL 学习笔记"></a>Thrift IDL 学习笔记</h1><p>​    Thrift 可以实现跨语言的接口描述，并通过代码生成引擎将 thrift 文件中定义的数据结构和服务转换成目标语言的代码。</p>
<h1 id="1-类型"><a href="#1-类型" class="headerlink" title="1 类型"></a>1 类型</h1><h2 id="1-1-基础数据类型"><a href="#1-1-基础数据类型" class="headerlink" title="1.1 基础数据类型"></a>1.1 基础数据类型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>bool</td>
<td>布尔类型，占用一个字节（和C++中一样）</td>
</tr>
<tr>
<td>byte</td>
<td>有符号的字符（相当于 signed char）</td>
</tr>
<tr>
<td>i16</td>
<td>16位的有符号整数（相当于short）</td>
</tr>
<tr>
<td>i32</td>
<td>32位的有符号整数（相当于 int）</td>
</tr>
<tr>
<td>i64</td>
<td>64位的有符号整数 （相当于 long long）</td>
</tr>
<tr>
<td>double</td>
<td>64 位的浮点数</td>
</tr>
<tr>
<td>binary</td>
<td>字符数组</td>
</tr>
<tr>
<td>string</td>
<td>字符串</td>
</tr>
</tbody></table>
<h2 id="1-2-容器类型"><a href="#1-2-容器类型" class="headerlink" title="1.2 容器类型"></a>1.2 容器类型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>list<T></T></td>
<td>T类型元素的列表</td>
</tr>
<tr>
<td>set<T></T></td>
<td>无序集合（相当于 C++ 中的unordered_set<T>）</T></td>
</tr>
<tr>
<td>map&lt;K, V&gt;</td>
<td>哈希映射</td>
</tr>
</tbody></table>
<h2 id="1-3-结构体类型"><a href="#1-3-结构体类型" class="headerlink" title="1.3 结构体类型"></a>1.3 结构体类型</h2><p>从概念上看，和 C 语言中的结构体 struct 相似，会被代码生成引擎转换成面向对象语言的Class。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct Tweet &#123;</span><br><span class="line">    1: required i32 userId;</span><br><span class="line">    2: required string userName;</span><br><span class="line">    3: required string text;</span><br><span class="line">    4: optional Location loc;</span><br><span class="line">    5: optional TweetType tweetType = TweetType.TWEET // 5</span><br><span class="line">    16: optional string language = &quot;english&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-4-异常类型"><a href="#1-4-异常类型" class="headerlink" title="1.4 异常类型"></a>1.4 异常类型</h2><p>Exception 在语法和功能上几乎和Struct等同，然而在语义上不同，可以在定义服务的时候声明可能抛出的异常类型。</p>
<h2 id="1-5-服务类型"><a href="#1-5-服务类型" class="headerlink" title="1.5 服务类型"></a>1.5 服务类型</h2><p>使用Service关键字声明的服务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">service Twitter &#123;</span><br><span class="line">    // A method definition looks like C code. It has a return type, arguments,</span><br><span class="line">    // and optionally a list of exceptions that it may throw. Note that argument</span><br><span class="line">    // lists and exception list are specified using the exact same syntax as</span><br><span class="line">    // field lists in structs.</span><br><span class="line">    void ping(),                                                             // </span><br><span class="line">    bool postTweet(1:Tweet tweet) throws (1:TwitterUnavailable unavailable), // </span><br><span class="line">    TweetSearchResult searchTweets(1:string query);                          // </span><br><span class="line"></span><br><span class="line">    // The &#x27;oneway&#x27; modifier indicates that the client only makes a request and</span><br><span class="line">    // does not wait for any response at all. Oneway methods MUST be void.</span><br><span class="line">    oneway void zip()                                                        // </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-Typedef"><a href="#2-Typedef" class="headerlink" title="2 Typedef"></a>2 Typedef</h1><p>相当于 C++ 中的 typedef，可以为底层数据类型起一个别名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef i32 MyInteger  </span><br><span class="line">typedef Tweet ReTweet  </span><br></pre></td></tr></table></figure>

<h1 id="3-Enum"><a href="#3-Enum" class="headerlink" title="3 Enum"></a>3 Enum</h1><p>概念上和 C 语言中的枚举类型相似，可以定义一组常量的集合。默认值从0开始，也可以自己指定，接受10进制和16进制形式的数值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">enum TweetType &#123;</span><br><span class="line">    TWEET,       </span><br><span class="line">    RETWEET = 2, </span><br><span class="line">    DM = 0xa,    </span><br><span class="line">    REPLY</span><br><span class="line">&#125;                </span><br><span class="line"></span><br><span class="line">struct Tweet &#123;</span><br><span class="line">    1: required i32 userId;</span><br><span class="line">    2: required string userName;</span><br><span class="line">    3: required string text;</span><br><span class="line">    4: optional Location loc;</span><br><span class="line">    5: optional TweetType tweetType = TweetType.TWEET // </span><br><span class="line"></span><br><span class="line">    16: optional string language = &quot;english&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-注释"><a href="#4-注释" class="headerlink" title="4 注释"></a>4 注释</h1><p>Thrift 支持 bash 风格注释、C++风格单行和多行注释。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># This is a valid comment.</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * This is a multi-line comment.</span><br><span class="line"> * Just like in C.</span><br><span class="line"> */</span><br><span class="line"> </span><br><span class="line">// C++/Java style single-line comments work just as well.</span><br></pre></td></tr></table></figure>

<h1 id="5-命名空间"><a href="#5-命名空间" class="headerlink" title="5 命名空间"></a>5 命名空间</h1><p>概念上和 C++ 中的命名空间相似，提供了一种代码的组织方式，可以避免名字冲突。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">namespace cpp com.example.project  </span><br><span class="line">namespace java com.example.project  </span><br></pre></td></tr></table></figure>

<ol>
<li>转换成 C++ 风格的命名空间嵌套，</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">namespace com &#123; namespace example &#123; namespace project &#123;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>转换成 Java 的包声明</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">package com.example.project</span><br></pre></td></tr></table></figure>

<h1 id="6-Include"><a href="#6-Include" class="headerlink" title="6 Include"></a>6 Include</h1><p>可以在thrift文件中使用include关键字包含另外一个thrift文件，和C++不同的是，使用include进的thrift文件中的内容需要显式地带上前缀。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include &quot;tweet.thrift&quot;            </span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">struct TweetSearchResult &#123;</span><br><span class="line">    1: list&lt;tweet.Tweet&gt; tweets;  // 注意：需要带上前缀</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="7-常量"><a href="#7-常量" class="headerlink" title="7 常量"></a>7 常量</h1><p>使用 const 关键字可以定义常量，对于复合数据类型和结构体用JSON格式表示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const i32 INT_CONST = 1234;    </span><br><span class="line"></span><br><span class="line">const map&lt;string,string&gt; MAP_CONST = &#123;&quot;hello&quot;: &quot;world&quot;, &quot;goodnight&quot;: &quot;moon&quot;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="8-定义结构体"><a href="#8-定义结构体" class="headerlink" title="8 定义结构体"></a>8 定义结构体</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct Location &#123;                            </span><br><span class="line"></span><br><span class="line">    1: required double latitude;</span><br><span class="line">    2: required double longitude;</span><br><span class="line">&#125;</span><br><span class="line">struct Tweet &#123;</span><br><span class="line">    1: required i32 userId;                   </span><br><span class="line"></span><br><span class="line">    2: required string userName;             </span><br><span class="line"></span><br><span class="line">    3: required string text;</span><br><span class="line">    4: optional Location loc;                </span><br><span class="line"></span><br><span class="line">    16: optional string language = &quot;english&quot; </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>对于结构体中的每一个属性，都 <strong>必须有一个</strong> 唯一的<strong>、</strong>正的 整数作为标识</li>
<li>属性可以被标记为 required (必须的)或 optional（可选的）</li>
<li>Struct 可以嵌套</li>
<li>可以为某一个属性指定默认值</li>
<li>在同一个thrift文件可以定义多个Struct</li>
<li>Struct 不支持继承，所以不能拓展（extends）另一个Struct</li>
</ol>
<h1 id="9-定义Service"><a href="#9-定义Service" class="headerlink" title="9 定义Service"></a>9 定义Service</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">service Twitter &#123;</span><br><span class="line">    // A method definition looks like C code. It has a return type, arguments,</span><br><span class="line">    // and optionally a list of exceptions that it may throw. Note that argument</span><br><span class="line">    // lists and exception list are specified using the exact same syntax as</span><br><span class="line">    // field lists in structs.</span><br><span class="line">    void ping(),                                                             // </span><br><span class="line">    bool postTweet(1:Tweet tweet) throws (1:TwitterUnavailable unavailable), // </span><br><span class="line">    TweetSearchResult searchTweets(1:string query);                          // </span><br><span class="line"></span><br><span class="line">    // The &#x27;oneway&#x27; modifier indicates that the client only makes a request and</span><br><span class="line">    // does not wait for any response at all. Oneway methods MUST be void.</span><br><span class="line">    oneway void zip()                                                        // </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>函数声明可以用 逗号 或 分号 间隔</li>
<li>参数和返回值可以是 基础数据类型 和 结构体</li>
<li>Void 也可以作为返回值类型</li>
<li>使用 throws 关键字声明函数可能会抛出的异常</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Lining Hoo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lining Hoo</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
